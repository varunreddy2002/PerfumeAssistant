<!-- templates/result.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Recommendations</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='results.css') }}" />
</head>
<img class="logo-image" src="{{ url_for('static', filename='IFF_Logo.svg') }}" alt="IFF Logo"/>
<body class="prompt-page">

  <script id="perfume-notes-data" type="application/json">
    {{ all_notes | tojson | safe }}
  </script>

  <script id="perfume-descriptions-data" type="application/json">
    {{ descriptions | tojson | safe }}
  </script>
  <h2 class='perfume_name' id="current-perfume-name" style="text-align:center; font-weight:600;">
    {{ perfumes[0] }}
  </h2>
  <div class="container">
    <div class="description-layout">
      
      <div class="description-column image-col">
        <img id="perfume-description-image" src="{{ url_for('static', filename='images/default.png') }}"
          alt="Perfume image" />
      </div>
      <div class="description-column text-col">
        <h4>{{selectedPerfume}}</h4>
        <p id="perfume-description-text">Click a perfume to view its description.</p>
      </div>

      <div class="description-column notes-col">
        <div class="note-box top-notes">
          <h4>Top Notes</h4>
          <ul id="top-notes-list"></ul>
        </div>
        <div class="note-box middle-notes">
          <h4>Middle Notes</h4>
          <ul id="middle-notes-list"></ul>
        </div>
        <div class="note-box base-notes">
          <h4>Base Notes</h4>
          <ul id="base-notes-list"></ul>
        </div>
      </div>
    </div>
    
    <div style="text-align:center; margin: 20px 0;">
      <button id="like-button" class="like-button" data-perfume = "{{perfumes[0]}}" onclick="toggleLike(this)">ü§ç</button>
    </div>

    <script>
      const likedPerfumes = new Set();

      async function toggleLike(button) {
        const perfume = button.dataset.perfume;
        const isLiked = likedPerfumes.has(perfume);

        let action;
        if (isLiked) {
          likedPerfumes.delete(perfume);
          action = 'remove';
          button.textContent = 'ü§ç';  // Unliked
        } else {
          likedPerfumes.add(perfume);
          action = 'add';
          button.textContent = '‚ù§Ô∏è';  // Liked
        }

        await fetch('/like', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            perfume: perfume,
            action: action,
            liked: Array.from(likedPerfumes)  // send full array
          })
        });
      }
    </script>
  </div>



  {% if perfumes %}
  <div class="perfume-buttons">
    <h4 class="rec_text">Your Perfect Scent Matches</h4>
    <div class="perfume-card-grid">
      {% for perfume in perfumes %}
      <div class="perfume-card" onclick="showNotes('{{ perfume }}')">
        <div class="perfume-image">
          <img src="{{ descriptions[perfume][1] }}" alt="{{ perfume }}">
        </div>
        <div class="perfume-info">
          <h4 class="perfume-name">{{ perfume }}</h4>
          <div class="top-notes-preview">
            {% for note in all_notes[perfume][0][:3] %}
            <span class="note-chip">{{ note }}</span>
            {% endfor %}
            {% if all_notes[perfume][0]|length > 3 %}
            <span class="note-chip">+{{ all_notes[perfume][0]|length - 3 }}</span>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
  <button type="button" id="backButton" class="send-button" aria-label="Back">New Scent Match</button>
  <script>
    const selectedPerfume = {{ perfumes[0] | tojson }};
    const perfumeNotes = JSON.parse(document.getElementById('perfume-notes-data').textContent);
    const perfumeDescriptions = JSON.parse(document.getElementById('perfume-descriptions-data').textContent);
    const descriptionText = document.getElementById('perfume-description-text');

    function updateNoteList(listId, notes) {
      const ul = document.getElementById(listId);
      ul.innerHTML = '';
      if (!notes) return;
      notes.forEach(note => {
        const li = document.createElement('li');
        li.textContent = note;
        ul.appendChild(li);
      });
    }

    function showNotes(perfumeName) {
      const notes = perfumeNotes[perfumeName];
      if (!notes) return;
      updateNoteList('top-notes-list', notes[0].slice(0, 3));
      updateNoteList('middle-notes-list', notes[1].slice(0, 3));
      updateNoteList('base-notes-list', notes[2].slice(0, 3));

      const descriptionData = perfumeDescriptions[perfumeName];
      if (descriptionData) {
        const [desc, imgPath] = descriptionData;
        descriptionText.textContent = desc;
        document.getElementById('perfume-description-image').src = imgPath;
      } else {
        descriptionText.textContent = "No description available.";
        document.getElementById('perfume-description-image').src = "{{ url_for('static', filename='images/default.png') }}";
      }
      document.getElementById('current-perfume-name').textContent = perfumeName;

      const likeButton = document.getElementById('like-button');
      likeButton.dataset.perfume = perfumeName;
      likeButton.textContent = likedPerfumes.has(perfumeName) ? '‚ù§Ô∏è' : 'ü§ç';

    }

    document.getElementById('backButton').onclick = () => {
      window.location.href = "{{ url_for('chat') }}";
    };

    // Auto-load the first perfume on page load
    window.addEventListener('DOMContentLoaded', () => {
      if (selectedPerfume) {
        showNotes(selectedPerfume);
      }
    });
  </script>
</body>
</html>

